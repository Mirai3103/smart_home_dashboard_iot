{% extends "base.html" %} {% block title %}Smart Home Dashboard{% endblock %} {%
block custom_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/dashboard.css') }}"
/>
<style>
  /* Floor navigation styles - Improved and consolidated */
  .floor-nav {
    margin-bottom: 20px;
  }
  .floor-nav .btn {
    margin-right: 5px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  .floor-nav .btn.active {
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.2);
    transform: translateY(-2px);
  }
  .floor-nav .btn .floor-indicator {
    position: absolute;
    top: 0;
    right: 0;
    padding: 2px 5px;
    font-size: 0.65rem;
    border-radius: 0 0 0 5px;
    opacity: 0.8;
  }
  .floor-container {
    display: none;
    transition: opacity 0.3s ease;
    opacity: 0;
  }
  .floor-container.active {
    display: block;
    opacity: 1;
  }
  .floor-header {
    margin-bottom: 20px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .floor-title {
    margin-bottom: 0;
  }
  .floor-description {
    font-style: italic;
    color: #6c757d;
    margin-top: 5px;
  }
  /* Room card improvements */
  .room-card {
    transition: all 0.3s ease;
    margin-bottom: 1.5rem;
    position: relative;
  }
  .room-card:hover {
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
  }
  .room-card .room-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .room-card .room-header .badge {
    position: absolute;
    top: 0;
    right: 0;
    border-radius: 0 0.25rem 0 0.25rem;
  }
  .room-card .room-body {
    padding: 1.25rem;
  }
  /* Device connections */
  .device-connections {
    margin-top: 0.5rem;
    font-size: 0.85rem;
  }
  .device-count-badge {
    position: absolute;
    top: 0;
    right: 0;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
  }
  /* New styles for device filtering */
  .filter-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
    padding: 10px 15px;
    margin-bottom: 15px;
  }

  .filter-card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
  }

  .filter-card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
  }

  .filter-device-item {
    transition: all 0.3s ease;
  }

  #filter-summary {
    font-size: 0.875rem;
  }

  #filter-summary .badge {
    margin-left: 5px;
  }

  /* Device count badge enhancement */
  .device-count-badge {
    position: absolute;
    top: 0;
    right: 0;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: bold;
  }
</style>
{% endblock %} {% block content %}
<div class="dashboard-header">
  <div class="row align-items-center">
    <div class="col-md-6">
      <h1><i class="fas fa-tachometer-alt me-2"></i>Smart Home Dashboard</h1>
      <p class="text-muted">
        Real-time monitoring and control for your connected home
      </p>
    </div>
    <div class="col-md-6 text-md-end">
      {% if current_user.is_admin and homes|length > 1 %}
      <div class="dropdown mb-3">
        <button
          class="btn btn-primary dropdown-toggle"
          type="button"
          id="homeSelector"
          data-bs-toggle="dropdown"
          aria-expanded="false"
        >
          <i class="fas fa-home me-1"></i> Select Home
        </button>
        <ul class="dropdown-menu" aria-labelledby="homeSelector">
          {% for home in homes %}
          <li>
            <a
              class="dropdown-item"
              href="{{ url_for('dashboard', home_id=home.id) }}"
              >{{ home.name }}</a
            >
          </li>
          {% endfor %}
        </ul>
      </div>
      {% else %} {% endif %}
    </div>
  </div>
</div>

<!-- Check if user has a home -->
{% if not homes %}
<div class="alert alert-info">
  <i class="fas fa-info-circle me-2"></i>
  You don't have any homes assigned yet. Please contact the administrator to set
  up your smart home.
</div>
{% elif not current_home %}
<div class="alert alert-warning">
  <i class="fas fa-exclamation-triangle me-2"></i>
  <!-- Removed the text: "Please select a home to view its dashboard." -->
</div>
{% else %}

<!-- Display the current home information -->
<div class="card mb-4">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">
      <i class="fas fa-home me-2"></i>{{ current_home.name }}
    </h5>
  </div>
  <div class="card-body">
    <p><i class="fas fa-map-marker-alt me-2"></i>{{ current_home.address }}</p>
    {% if current_home.owner_id == current_user.id %}
    <span class="badge bg-success">
      <i class="fas fa-user-check me-1"></i>
      Owner
    </span>
    {% else %}
    <span class="badge bg-info">
      <i class="fas fa-user-friends me-1"></i>Guest Access
    </span>
    {% endif %}
  </div>
</div>

<!-- Check if home has any devices -->
{% set total_devices = 0 %} {% for floor in current_home.floors %} {% for room
in floor.rooms %} {% set total_devices = total_devices + room.devices|length %}
{% endfor %} {% endfor %}

<!-- Debug Info -->
<script>
  console.log('Total devices: {{ total_devices }}');
  // Log API device data when loaded (new)
  window.apiDevicesLoaded = function (count) {
    console.log('API devices loaded: ' + count);
    document.getElementById('api-device-count').textContent = count;
  };
</script>

<!-- Hidden counter to track API device count -->
<span id="api-device-count" style="display: none">0</span>

<!-- Add a container for additional filtering options -->
<div id="device-filter-container" style="display: none" class="mb-4">
  <div class="card filter-card">
    <div class="card-header filter-header">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filter Devices</h5>
        <div>
          <button
            class="btn btn-sm btn-outline-secondary"
            id="toggleFiltersBtn"
          >
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="card-body" id="filterBody">
      <div class="row">
        <div class="col-md-4 mb-2">
          <label for="dashFilterFloor" class="form-label">Floor</label>
          <select id="dashFilterFloor" class="form-select form-select-sm">
            <option value="all" selected>All Floors</option>
            {% for floor in current_home.floors|sort(attribute='floor_number')
            %}
            <option value="{{ floor.floor_number }}">
              {{ floor.name or 'Floor ' ~ floor.floor_number }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4 mb-2">
          <label for="dashFilterRoom" class="form-label">Room</label>
          <select id="dashFilterRoom" class="form-select form-select-sm">
            <option value="all" selected>All Rooms</option>
            {% set rooms = [] %} {% for floor in current_home.floors %} {% for
            room in floor.rooms %} {% if room.name not in rooms %} {% set rooms
            = rooms + [room.name] %}
            <option value="{{ room.name|lower|replace(' ', '_') }}">
              {{ room.name }}
            </option>
            {% endif %} {% endfor %} {% endfor %}
          </select>
        </div>
        <div class="col-md-4 mb-2">
          <label for="dashFilterType" class="form-label">Device Type</label>
          <select id="dashFilterType" class="form-select form-select-sm">
            <option value="all" selected>All Types</option>
            {% set device_types = [] %} {% for floor in current_home.floors %}
            {% for room in floor.rooms %} {% for device in room.devices %} {% if
            device.type not in device_types %} {% set device_types =
            device_types + [device.type] %}
            <option value="{{ device.type }}">
              {{ device.type|capitalize|replace('_', ' ') }}
            </option>
            {% endif %} {% endfor %} {% endfor %} {% endfor %}
          </select>
        </div>
      </div>
      <div class="d-flex justify-content-end mt-2">
        <button class="btn btn-sm btn-primary me-2" id="applyFilterBtn">
          <i class="fas fa-check me-1"></i>Apply Filter
        </button>
        <button class="btn btn-sm btn-secondary" onclick="resetDashFilters()">
          <i class="fas fa-undo-alt me-1"></i>Reset
        </button>
      </div>
      <div
        id="dash-filter-summary"
        class="alert alert-light mt-2 mb-0"
        style="display: none"
      ></div>
    </div>
  </div>
</div>

{% if total_devices == 0 %}
<div class="alert alert-info" id="no-devices-message">
  <i class="fas fa-info-circle me-2"></i>
  This home doesn't have any devices registered yet. Please contact the
  administrator to set up smart home devices.
</div>
{% else %}

<!-- Dashboard Stats Summary - Improved layout to better connect with floors -->
<div class="row dashboard-stats">
  <div class="col-md-3 col-sm-6">
    <div class="stat-card">
      <div class="stat-card-icon text-primary">
        <i class="fas fa-microchip"></i>
      </div>
      <div class="stat-card-title">Connected Devices</div>
      <div class="stat-card-value" id="totalDevices">{{ total_devices }}</div>
    </div>
  </div>

  {% set online_devices = 0 %} {% for floor in current_home.floors %} {% for
  room in floor.rooms %} {% for device in room.devices %} {% if device.status ==
  'online' %} {% set online_devices = online_devices + 1 %} {% endif %} {%
  endfor %} {% endfor %} {% endfor %}

  <div class="col-md-3 col-sm-6">
    <div class="stat-card">
      <div class="stat-card-icon text-success">
        <i class="fas fa-wifi"></i>
      </div>
      <div class="stat-card-title">Online Devices</div>
      <div class="stat-card-value" id="onlineDevices">{{ online_devices }}</div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6">
    <div class="stat-card">
      <div class="stat-card-icon text-warning">
        <i class="fas fa-thermometer-half"></i>
      </div>
      <div class="stat-card-title">Average Temperature</div>
      <div class="stat-card-value" id="avg-temperature">30°C</div>
    </div>
  </div>

  <div class="col-md-3 col-sm-6">
    <div class="stat-card">
      <div class="stat-card-icon text-info">
        <i class="fas fa-tint"></i>
      </div>
      <div class="stat-card-title">Average Humidity</div>
      <div class="stat-card-value" id="avg-humidity">30%</div>
    </div>
  </div>
</div>

<!-- Improved Floor Navigation with device counts -->
<div class="card mb-4">
  <div class="card-header bg-dark text-white">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="fas fa-building me-2"></i>Floor Navigation</h5>
      <button id="showFilterBtn" class="btn btn-sm btn-outline-light">
        <i class="fas fa-filter me-1"></i>Filter
      </button>
    </div>
  </div>
  <div class="card-body">
    <div class="floor-nav text-center">
      <div class="btn-group" role="group" aria-label="Floor navigation">
        {% if current_home.floors %} {% for floor in
        current_home.floors|sort(attribute='floor_number') %} {% set floor_info
        = { 'name': floor.name or 'Floor ' ~ floor.floor_number, 'icon':
        'building', 'color': 'primary' if floor.floor_number == 1 else 'info' if
        floor.floor_number == 2 else 'success' if floor.floor_number == 3 else
        'secondary' } %} {% set floor_device_count = 0 %} {% for room in
        floor.rooms %} {% set floor_device_count = floor_device_count +
        room.devices|length %} {% endfor %}

        <button
          type="button"
          class="btn btn-outline-{{ floor_info['color'] }} floor-button {% if loop.first %}active{% endif %}"
          data-floor="{{ floor.floor_number }}"
          data-device-count="{{ floor_device_count }}"
          data-floor-name="{{ floor.name or 'Floor ' ~ floor.floor_number }}"
        >
          <i class="fas fa-{{ floor_info['icon'] }} me-1"></i>
          {{ floor.name or 'Floor ' ~ floor.floor_number }}
          <!-- Add device count indicator -->
          <span class="floor-indicator bg-{{ floor_info['color'] }} text-white">
            {{ floor_device_count }} device{% if floor_device_count != 1 %}s{%
            endif %}
          </span>
        </button>
        {% endfor %} {% else %}
        <div class="alert alert-warning w-100">
          No floors available for this home
        </div>
        {% endif %}
      </div>
    </div>
  </div>
  <!-- Debug information now collapsible for better UX -->
  <div class="card-footer p-0">
    <button
      class="btn btn-sm btn-link w-100 text-muted"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#floor-debug-info"
    >
      <small><i class="fas fa-info-circle me-1"></i> Debug Information</small>
    </button>
    <div id="floor-debug-info" class="collapse small p-2 text-muted">
      <p>Total Floors: {{ current_home.floors|length }}</p>
      <p>
        Total Devices: <span id="debug-device-count">{{ total_devices }}</span>
      </p>
    </div>
  </div>
</div>

<!-- Overview Chart -->
<div class="card mb-4">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="fas fa-chart-line me-2"></i>24 Hour Overview
      </h5>
      <div class="btn-group btn-group-sm" role="group">
        <button type="button" class="btn btn-outline-primary active">
          Temperature
        </button>
        <button type="button" class="btn btn-outline-primary">Humidity</button>
        <button type="button" class="btn btn-outline-primary">All Data</button>
      </div>
    </div>
  </div>
  <div class="card-body">
    <div class="timeline-chart-container" id="overview-chart">
      <canvas></canvas>
    </div>
  </div>
</div>

<!-- Improved Floor Containers with better hierarchy -->
{% set floor_descriptions = { 1: "The main floor contains common areas like the
living room, kitchen, and dining room.", 2: "The residential floor contains
bedrooms, bathrooms, and personal spaces.", 3: "The entertainment floor contains
spaces for leisure and recreational activities." } %} {% for floor in
current_home.floors|sort(attribute='floor_number') %}
<div
  class="floor-container {% if loop.first %}active{% endif %}"
  id="floor-{{ floor.floor_number }}"
>
  <div class="floor-header">
    {% set floor_info = { 'name': floor.name or 'Floor ' ~ floor.floor_number,
    'icon': 'building', 'color': 'primary' if floor.floor_number == 1 else
    'info' if floor.floor_number == 2 else 'success' if floor.floor_number == 3
    else 'secondary' } %}

    <div class="floor-title">
      <h2 class="floor-title">
        <i
          class="fas fa-{{ floor_info['icon'] }} me-2 text-{{ floor_info['color'] }}"
        ></i>
        {{ floor.name or 'Floor ' ~ floor.floor_number }}
      </h2>
      <p class="floor-description">
        {{ floor_descriptions.get(floor.floor_number, 'This floor contains
        various rooms and devices.') }}
      </p>
    </div>

    <div class="floor-summary">
      <div class="badge bg-{{ floor_info['color'] }} p-2">
        <i class="fas fa-door-open me-1"></i>
        {{ floor.rooms|length }} Room{% if floor.rooms|length != 1 %}s{% endif
        %} {% set floor_device_count = 0 %} {% for room in floor.rooms %} {% set
        floor_device_count = floor_device_count + room.devices|length %} {%
        endfor %}

        <span class="mx-1">|</span>
        <i class="fas fa-microchip me-1"></i>
        {{ floor_device_count }} Device{% if floor_device_count != 1 %}s{% endif
        %}
      </div>
    </div>
  </div>

  <!-- Room cards for this floor - Improved organization -->
  {% if floor.rooms %}
  <div class="row">
    {% for room in floor.rooms|sort(attribute='name') %}
    <div class="col-lg-6 col-12">
      <div class="card room-card">
        <div
          class="card-header bg-{{ floor_info['color'] }} text-white room-header"
        >
          <h5 class="mb-0">
            <i class="fas fa-door-open me-2"></i>{{ room.name }}
          </h5>
          <span class="badge bg-dark">
            {{ floor.name or 'Floor ' ~ floor.floor_number }}
          </span>
        </div>

        <div class="card-body room-body">
          {% if room.devices %}
          <div class="row">
            {% for device in room.devices %}
            <div class="col-md-6 mb-3 device-card-container">
              {% set device_type =
              device.type|default('generic')|lower|replace(' ', '_') %} {% if
              device_type == 'temperature' or device_type ==
              'temperature_sensor' %} {% include
              'device_templates/temperature.html' %} {% elif device_type ==
              'humidity' or device_type == 'humidity_sensor' %} {% include
              'device_templates/humidity.html' %} {% elif device_type == 'light'
              or device_type == 'light_switch' or device_type == 'smart_light'
              %} {% include 'device_templates/light.html' %} {% elif device_type
              == 'smoke_detector' %} {% include
              'device_templates/smoke_detector.html' %} {% elif device_type ==
              'motion' or device_type == 'motion_sensor' %} {% include
              'device_templates/motion.html' %} {% elif device_type == 'ac' or
              device_type == 'air_conditioner' %} {% include
              'device_templates/ac.html' %} {% elif device_type == 'tv' or
              device_type == 'television' %} {% include
              'device_templates/tv.html' %} {% elif device_type ==
              'security_camera' or device_type == 'camera' %} {% include
              'device_templates/security_camera.html' %} {% elif device_type ==
              'speaker' or device_type == 'smart_speaker' %} {% include
              'device_templates/speaker.html' %} {% elif device_type ==
              'smart_oven' or device_type == 'oven' %} {% include
              'device_templates/smart_oven.html' %} {% elif device_type ==
              'smart_refrigerator' or device_type == 'refrigerator' %} {%
              include 'device_templates/smart_refrigerator.html' %} {% elif
              device_type == 'garage_door_controller' or device_type ==
              'garage_door' %} {% include
              'device_templates/garage_door_controller.html' %} {% elif
              device_type == 'car_charger' or device_type == 'ev_charger' %} {%
              include 'device_templates/car_charger.html' %} {% elif device_type
              == 'water_leak_sensor' or device_type == 'leak_sensor' %} {%
              include 'device_templates/water_leak_sensor.html' %} {% elif
              device_type == 'weather_station' or device_type == 'weather' %} {%
              include 'device_templates/weather_station.html' %} {% elif
              device_type == 'smart_alarm' or device_type == 'alarm' %} {%
              include 'device_templates/smart_alarm.html' %} {% elif device_type
              == 'irrigation_control' or device_type == 'irrigation' %} {%
              include 'device_templates/irrigation_control.html' %} {% elif
              device_type == 'smart_mirror' or device_type == 'mirror' %} {%
              include 'device_templates/smart_mirror.html' %} {% elif
              device_type == 'smart_scale' or device_type == 'scale' %} {%
              include 'device_templates/smart_scale.html' %} {% elif device_type
              == 'light_sensor' %} {% include
              'device_templates/light_sensor.html' %} {% else %} {% include
              'device_templates/generic.html' %} {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No devices found in this room.
          </div>
          {% endif %}
        </div>

        <!-- Room footer with device count summary -->
        <div class="card-footer text-muted">
          <small>
            <i class="fas fa-microchip me-1"></i>
            {{ room.devices|length }} device{% if room.devices|length != 1 %}s{%
            endif %} in this room
          </small>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-warning">
    <i class="fas fa-exclamation-triangle me-2"></i>
    No rooms found for this floor.
  </div>
  {% endif %}
</div>
{% endfor %} {% endif %} {% endif %} {% endblock %} {% block custom_js %}
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
<script>
  // Improved floor navigation functionality with better error handling
  document.addEventListener('DOMContentLoaded', function () {
    // Create a local scope for these functions to avoid global namespace conflicts
    (function () {
      const floorButtons = document.querySelectorAll('.floor-button');
      const floorContainers = document.querySelectorAll('.floor-container');

      // Helper function to log navigation events for debugging
      function logNavEvent(message) {
        console.log(`[Floor Navigation] ${message}`);
      }

      // Helper to update visibility properly
      function setFloorVisibility(floorContainer, isVisible) {
        if (!floorContainer) return;

        if (isVisible) {
          floorContainer.classList.add('active');
          floorContainer.style.display = 'block';

          // Use setTimeout to ensure the display change takes effect before applying opacity
          setTimeout(() => {
            // Check if element still exists before setting property
            if (floorContainer && floorContainer.style) {
              floorContainer.style.opacity = '1';
            }
          }, 10);
        } else {
          floorContainer.classList.remove('active');

          // Check if element exists before setting property
          if (floorContainer && floorContainer.style) {
            floorContainer.style.opacity = '0';
          }

          // Don't hide the element immediately, wait for fade out
          setTimeout(() => {
            if (
              floorContainer &&
              !floorContainer.classList.contains('active')
            ) {
              floorContainer.style.display = 'none';
            }
          }, 300);
        }
      }

      // Add click event to floor buttons
      floorButtons.forEach((button) => {
        button.addEventListener('click', function () {
          const floorNum = this.getAttribute('data-floor');
          const deviceCount = this.getAttribute('data-device-count') || '0';

          logNavEvent(
            `Switching to floor ${floorNum} with ${deviceCount} devices`
          );

          // Update active button
          floorButtons.forEach((btn) => btn.classList.remove('active'));
          this.classList.add('active');

          // Show selected floor, hide others
          floorContainers.forEach((container) => {
            const isTargetFloor = container.id === `floor-${floorNum}`;
            setFloorVisibility(container, isTargetFloor);

            if (isTargetFloor) {
              logNavEvent(`Showing floor container: ${container.id}`);
            }
          });

          // Update URL with selected floor
          const url = new URL(window.location);
          url.searchParams.set('floor', floorNum);
          window.history.replaceState({}, '', url);

          // Trigger custom event for analytics or other components
          document.dispatchEvent(
            new CustomEvent('floorChanged', {
              detail: {
                floorNumber: floorNum,
                deviceCount: parseInt(deviceCount),
              },
            })
          );
        });
      });

      // Check URL parameters for floor selection on page load
      function initializeFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const floorParam = urlParams.get('floor');

        if (floorParam) {
          logNavEvent(`URL contains floor parameter: ${floorParam}`);
          const floorButton = document.querySelector(
            `.floor-button[data-floor="${floorParam}"]`
          );

          if (floorButton) {
            floorButton.click();
            return true;
          } else {
            logNavEvent(`No button found for floor ${floorParam}`);
          }
        }
        return false;
      }

      // Fix floor visibility issues
      function fixFloorVisibility() {
        const activeFloor = document.querySelector('.floor-container.active');

        // If no active floor or active floor is hidden, show the first one
        if (
          !activeFloor ||
          window.getComputedStyle(activeFloor).display === 'none'
        ) {
          logNavEvent('No active floor found or active floor is hidden');
          if (floorContainers.length > 0) {
            const firstFloor = floorContainers[0];
            setFloorVisibility(firstFloor, true);
            logNavEvent(`Set first floor as active: ${firstFloor.id}`);

            // Also activate the corresponding button, if any
            if (floorButtons.length > 0) {
              floorButtons[0].classList.add('active');
            }
          }
        } else if (
          activeFloor &&
          window.getComputedStyle(activeFloor).display === 'none'
        ) {
          // Fix a specific case where active class exists but display is still none
          setFloorVisibility(activeFloor, true);
          logNavEvent(
            `Fixed display issue with active floor: ${activeFloor.id}`
          );
        }
      }

      // Initialize floor navigation
      function initializeFloorNavigation() {
        // Try URL-based initialization first
        if (!initializeFromUrl()) {
          // If no floor was selected from URL, make sure something is visible
          fixFloorVisibility();
        }

        // Final verification that something is visible
        setTimeout(() => {
          const anyVisible = Array.from(floorContainers).some(
            (container) => window.getComputedStyle(container).display !== 'none'
          );

          if (!anyVisible && floorContainers.length > 0) {
            logNavEvent(
              'CRITICAL: No floor containers visible after initialization'
            );

            // Force first floor visible as last resort
            setFloorVisibility(floorContainers[0], true);
            if (floorButtons.length > 0) {
              floorButtons[0].classList.add('active');
            }
          }
        }, 300);
      }

      // Run initialization
      initializeFloorNavigation();

      // Additional check after full page load
      window.addEventListener('load', function () {
        setTimeout(fixFloorVisibility, 100);

        // Check for "no devices" message
        const deviceCards = document.querySelectorAll('.device-card');
        const noDevicesMessage = document.getElementById('no-devices-message');

        if (deviceCards.length > 0 && noDevicesMessage) {
          noDevicesMessage.style.display = 'none';
          logNavEvent('Hidden no-devices message because devices exist');
        }

        // Update debug counter - Add null check to fix the error
        const debugCounter = document.getElementById('debug-device-count');
        if (debugCounter) {
          debugCounter.textContent = deviceCards.length;
        } else {
          console.warn('Debug device count element not found in the DOM');
        }
      });

      // Device control functionality - Send commands to server via REST API
      const deviceActionButtons =
        document.querySelectorAll('.device-action-btn');

      // Event delegation for device actions
      deviceActionButtons.forEach((btn) => {
        btn.addEventListener('click', function () {
          const deviceId = this.getAttribute('data-device-id');
          const action = this.getAttribute('data-action');
          let payload = {};

          // Different actions for different device types
          if (deviceId.includes('temp')) {
            if (action === 'calibrate') {
              payload = { command: 'calibrate', value: 0, unit: 'celsius' };
            } else if (action === 'set_threshold') {
              const threshold = prompt(
                'Enter temperature threshold (°C):',
                '25'
              );
              if (threshold === null) return; // User canceled
              payload = {
                command: 'set_threshold',
                value: parseFloat(threshold),
                unit: 'celsius',
              };
            } else if (action === 'power_save') {
              payload = { command: 'power_save', value: true };
            }
          } else if (deviceId.includes('humidity')) {
            if (action === 'calibrate') {
              payload = { command: 'calibrate', value: 0, unit: 'percent' };
            } else if (action === 'set_threshold') {
              const threshold = prompt('Enter humidity threshold (%):', '50');
              if (threshold === null) return; // User canceled
              payload = {
                command: 'set_threshold',
                value: parseFloat(threshold),
                unit: 'percent',
              };
            } else if (action === 'auto_mode') {
              payload = { command: 'auto_mode', value: true };
            }
          } else if (deviceId.includes('light')) {
            if (action === 'toggle') {
              const currentState = this.getAttribute('data-state') === 'on';
              const newState = !currentState;
              this.setAttribute('data-state', newState ? 'on' : 'off');
              payload = { command: 'power', value: newState };
            } else if (action === 'brightness') {
              const brightness = prompt(
                'Enter brightness level (0-100):',
                '50'
              );
              if (brightness === null) return; // User canceled
              payload = {
                command: 'brightness',
                value: parseInt(brightness),
                unit: 'percent',
              };
            } else if (action === 'color_temp') {
              const colorTemp = prompt(
                'Enter color temperature (2700-6500K):',
                '4000'
              );
              if (colorTemp === null) return; // User canceled
              payload = {
                command: 'color_temp',
                value: parseInt(colorTemp),
                unit: 'kelvin',
              };
            }
          }

          // Send command to device via API
          sendDeviceCommand(deviceId, action, payload);

          // Show feedback to user
          showCommandFeedback(deviceId, action);
        });
      });

      function sendDeviceCommand(deviceId, action, payload) {
        // Add timestamp and device ID to payload
        payload.timestamp = new Date().toISOString();
        payload.device_id = deviceId;
        payload.action = action;

        // Use the existing '/api/devices/${deviceId}/control' endpoint
        fetch(`/api/devices/${deviceId}/control`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
          },
          credentials: 'same-origin',
          body: JSON.stringify(payload),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('Command sent successfully:', data);
            if (data.success) {
              showCommandFeedback(deviceId, action, 'success');
            } else {
              showCommandFeedback(deviceId, action, 'danger');
            }
          })
          .catch((error) => {
            console.error('Error sending command:', error);
            showCommandFeedback(deviceId, action, 'danger');
          });
      }

      function showCommandFeedback(deviceId, action, status = 'success') {
        // Display a temporary notification near the device
        const deviceElement = document.querySelector(
          `[data-device-id="${deviceId}"]`
        );

        if (!deviceElement) return;

        const feedbackElement = document.createElement('div');
        feedbackElement.classList.add(
          'command-feedback',
          'alert',
          `alert-${status}`,
          'position-absolute'
        );
        feedbackElement.style.top = '10px';
        feedbackElement.style.right = '10px';
        feedbackElement.style.zIndex = '100';
        feedbackElement.style.opacity = '0';
        feedbackElement.style.transition = 'opacity 0.3s ease-in-out';
        feedbackElement.style.padding = '8px 12px';
        feedbackElement.style.fontSize = '14px';
        feedbackElement.style.borderRadius = '4px';
        feedbackElement.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';

        if (status === 'success') {
          feedbackElement.textContent = `Command "${action}" sent!`;
        } else {
          feedbackElement.textContent = `Failed to send "${action}"`;
        }

        deviceElement.style.position = 'relative';
        deviceElement.appendChild(feedbackElement);

        // Show and then fade out
        setTimeout(() => {
          feedbackElement.style.opacity = '1';
        }, 10);

        setTimeout(() => {
          feedbackElement.style.opacity = '0';
          setTimeout(() => feedbackElement.remove(), 300);
        }, 2000);
      }

      // Setup filtering functionality
      const showFilterBtn = document.getElementById('showFilterBtn');
      const filterContainer = document.getElementById(
        'device-filter-container'
      );
      const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');

      if (showFilterBtn && filterContainer) {
        showFilterBtn.addEventListener('click', function () {
          filterContainer.style.display =
            filterContainer.style.display === 'none' ? 'block' : 'none';
          showFilterBtn.innerHTML =
            filterContainer.style.display === 'none'
              ? '<i class="fas fa-filter me-1"></i>Filter'
              : '<i class="fas fa-times me-1"></i>Hide Filters';
        });
      }

      if (toggleFiltersBtn) {
        const filterBody = document.getElementById('filterBody');
        toggleFiltersBtn.addEventListener('click', function () {
          if (filterBody) {
            filterBody.style.display =
              filterBody.style.display === 'none' ? 'block' : 'none';
            toggleFiltersBtn.innerHTML =
              filterBody.style.display === 'none'
                ? '<i class="fas fa-chevron-down"></i>'
                : '<i class="fas fa-chevron-up"></i>';
          }
        });
      }

      // Setup dashboard filters functionality
      const dashFilterFloor = document.getElementById('dashFilterFloor');
      const dashFilterRoom = document.getElementById('dashFilterRoom');
      const dashFilterType = document.getElementById('dashFilterType');

      function applyDashboardFilters() {
        const floorFilter = dashFilterFloor?.value || 'all';
        const roomFilter = dashFilterRoom?.value || 'all';
        const typeFilter = dashFilterType?.value || 'all';

        const deviceCards = document.querySelectorAll('.device-card');
        let visibleCount = 0;

        deviceCards.forEach((card) => {
          const room = card.dataset.room || '';
          const floor = card.dataset.floor || '';
          const deviceType = card.dataset.deviceType || '';

          const floorMatch = floorFilter === 'all' || floor === floorFilter;
          const roomMatch = roomFilter === 'all' || room === roomFilter;
          const typeMatch = typeFilter === 'all' || deviceType === typeFilter;

          const container = card.closest('.device-card-container');

          if (floorMatch && roomMatch && typeMatch) {
            if (container) container.style.display = 'block';
            visibleCount++;
          } else {
            if (container) container.style.display = 'none';
          }
        });

        // Update filter summary
        updateDashFilterSummary(
          floorFilter,
          roomFilter,
          typeFilter,
          visibleCount
        );

        return visibleCount;
      }

      function updateDashFilterSummary(floor, room, type, count) {
        const summary = document.getElementById('dash-filter-summary');
        if (summary) {
          summary.style.display = 'block';

          const floorText =
            floor === 'all'
              ? 'All Floors'
              : document.querySelector(
                  `#dashFilterFloor option[value="${floor}"]`
                )?.textContent || `Floor ${floor}`;

          const roomText =
            room === 'all'
              ? 'All Rooms'
              : document.querySelector(
                  `#dashFilterRoom option[value="${room}"]`
                )?.textContent || room;

          const typeText =
            type === 'all'
              ? 'All Types'
              : document.querySelector(
                  `#dashFilterType option[value="${type}"]`
                )?.textContent || type;

          summary.innerHTML = `
            <strong>Showing:</strong> ${count} device${count !== 1 ? 's' : ''}
            <span class="badge bg-primary">${floorText}</span>
            <span class="badge bg-secondary">${roomText}</span>
            <span class="badge bg-info">${typeText}</span>
            <button class="btn btn-sm btn-outline-secondary float-end" onclick="resetDashFilters()">
              <i class="fas fa-undo-alt me-1"></i>Reset
            </button>
          `;
        }
      }

      function resetDashFilters() {
        if (dashFilterFloor) dashFilterFloor.value = 'all';
        if (dashFilterRoom) dashFilterRoom.value = 'all';
        if (dashFilterType) dashFilterType.value = 'all';
        applyDashboardFilters();
      }

      // Make function globally available
      window.resetDashFilters = resetDashFilters;

      // Add filter event listeners
      if (dashFilterFloor) {
        dashFilterFloor.addEventListener('change', applyDashboardFilters);
      }

      if (dashFilterRoom) {
        dashFilterRoom.addEventListener('change', applyDashboardFilters);
      }

      if (dashFilterType) {
        dashFilterType.addEventListener('change', applyDashboardFilters);
      }

      // Check if we have devices and show filter button if needed
      const deviceCount = document.querySelectorAll('.device-card').length;
      if (deviceCount > 0 && filterContainer) {
        filterContainer.style.display = 'none'; // Hidden by default
        if (showFilterBtn) {
          showFilterBtn.style.display = 'block'; // Show the filter button
        }
      }
    })(); // Immediately invoke the function to create a closure
  });

  // Add toast notification system for debug info and status updates
  function showToast(message, type = 'info') {
    const toastContainer =
      document.getElementById('toast-container') || createToastContainer();

    const toast = document.createElement('div');
    toast.className = `toast show bg-${type} text-white`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    toast.innerHTML = `
      <div class="toast-header bg-${type} text-white">
        <strong class="me-auto">Dashboard Notification</strong>
        <small>Just now</small>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        ${message}
      </div>
    `;

    toastContainer.appendChild(toast);

    // Auto dismiss after 5 seconds
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 5000);
  }

  function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '1050';
    document.body.appendChild(container);
    return container;
  }

  // Add fail-safe script to fix device visibility issues
  document.addEventListener('DOMContentLoaded', function () {
    const apiDeviceCountEl = document.getElementById('api-device-count');

    if (apiDeviceCountEl) {
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          try {
            const deviceCount = parseInt(apiDeviceCountEl.textContent, 10);
            if (deviceCount > 0) {
              const noDevicesMessage =
                document.getElementById('no-devices-message');
              if (noDevicesMessage) {
                noDevicesMessage.style.display = 'none';
                console.log('Hidden no-devices-message via mutation observer');
              }

              const dashboardStats = document.querySelector('.dashboard-stats');
              if (
                dashboardStats &&
                window.getComputedStyle(dashboardStats).display === 'none'
              ) {
                dashboardStats.style.display = 'flex';
                console.log('Shown dashboard-stats via mutation observer');
              }

              const activeFloor = document.querySelector(
                '.floor-container.active'
              );
              if (
                activeFloor &&
                window.getComputedStyle(activeFloor).display === 'none'
              ) {
                activeFloor.style.display = 'block';
                console.log('Fixed active floor display via mutation observer');
              }
            }
          } catch (e) {
            console.error('Error in mutation observer:', e);
          }
        });
      });

      observer.observe(apiDeviceCountEl, {
        childList: true,
        characterData: true,
        subtree: true,
      });
    } else {
      console.warn(
        'API device count element not found, skipping mutation observer'
      );
    }

    // Try to fix common display issues anyway
    setTimeout(() => {
      try {
        const deviceCards = document.querySelectorAll('.device-card');
        if (deviceCards.length > 0) {
          const noDevicesMessage =
            document.getElementById('no-devices-message');
          if (noDevicesMessage) {
            noDevicesMessage.style.display = 'none';
          }

          // Ensure at least one floor is visible
          const activeFloor = document.querySelector('.floor-container.active');
          if (!activeFloor) {
            const firstFloor = document.querySelector('.floor-container');
            if (firstFloor) {
              firstFloor.classList.add('active');
              firstFloor.style.display = 'block';
              firstFloor.style.opacity = '1';
            }
          }
        }
      } catch (e) {
        console.error('Error in fallback visibility fix:', e);
      }
    }, 300);
  });

  // Add device card data-attribute enhancement for filtering
  document.addEventListener('DOMContentLoaded', function () {
    // Add necessary data attributes to device cards for filtering
    const deviceCards = document.querySelectorAll('.device-card');

    deviceCards.forEach((card) => {
      const roomHeader = card
        .closest('.room-card')
        ?.querySelector('.room-header h5');
      const roomName = roomHeader ? roomHeader.textContent.trim() : '';

      const floorBadge = card.closest('.room-card')?.querySelector('.badge');
      const floorText = floorBadge ? floorBadge.textContent.trim() : '';

      // Extract floor number - either from floor text or from the active floor
      let floorNum = '';
      if (floorText) {
        const match = floorText.match(/Floor\s+(\d+)/);
        if (match) floorNum = match[1];
      }

      // If no floor number found, try to get it from the active floor container
      if (!floorNum) {
        const activeFloor = document.querySelector('.floor-container.active');
        if (activeFloor) {
          const floorIdMatch = activeFloor.id.match(/floor-(\d+)/);
          if (floorIdMatch) floorNum = floorIdMatch[1];
        }
      }

      // Set data attributes for filtering
      if (roomName) {
        card.dataset.room = roomName.toLowerCase().replace(/\s+/g, '_');
      }
      if (floorNum) {
        card.dataset.floor = floorNum;
      }

      // Ensure device type is set
      if (!card.dataset.deviceType) {
        // Try to determine from device class or content
        if (card.querySelector('.fa-thermometer-half')) {
          card.dataset.deviceType = 'temperature';
        } else if (card.querySelector('.fa-tint')) {
          card.dataset.deviceType = 'humidity';
        } else if (card.querySelector('.fa-lightbulb')) {
          card.dataset.deviceType = 'light';
        } else {
          card.dataset.deviceType = 'generic';
        }
      }
    });

    console.log(
      `Enhanced ${deviceCards.length} device cards with data attributes for filtering`
    );
  });

  // Add permanent "no devices" message handling
  document.addEventListener('DOMContentLoaded', function () {
    // Permanently hide no devices message when API confirms devices exist
    const apiDeviceCountEl = document.getElementById('api-device-count');
    const noDevicesMessage = document.getElementById('no-devices-message');

    // Create a style element to hide the message with !important
    function createHidingStyle() {
      const style = document.createElement('style');
      style.textContent = '#no-devices-message { display: none !important; }';
      document.head.appendChild(style);
    }

    // Observer for API device count changes
    const observer = new MutationObserver(function (mutations) {
      mutations.forEach(function (mutation) {
        if (apiDeviceCountEl && parseInt(apiDeviceCountEl.textContent) > 0) {
          console.log(
            'API confirms devices exist, permanently hiding no-devices message'
          );
          createHidingStyle();

          // Show floor containers
          document.querySelectorAll('.floor-container').forEach((container) => {
            if (container.classList.contains('active')) {
              container.style.display = 'block';
            }
          });

          // Enable dashboard stats
          const dashboardStats = document.querySelector('.dashboard-stats');
          if (dashboardStats) {
            dashboardStats.style.display = 'flex';
          }

          observer.disconnect();
        }
      });
    });

    if (apiDeviceCountEl) {
      observer.observe(apiDeviceCountEl, {
        childList: true,
        characterData: true,
        subtree: true,
      });
    }

    // Initial check in case API already loaded
    if (apiDeviceCountEl && parseInt(apiDeviceCountEl.textContent) > 0) {
      console.log(
        'API already confirms devices exist, hiding no-devices message'
      );
      if (noDevicesMessage) {
        noDevicesMessage.style.display = 'none';
      }
      createHidingStyle();
    }
  });

  // Improved device card data-attribute enhancement for filtering
  document.addEventListener('DOMContentLoaded', function () {
    // Add necessary data attributes to device cards for filtering
    const deviceCards = document.querySelectorAll('.device-card');

    deviceCards.forEach((card) => {
      const roomCard = card.closest('.room-card');
      if (!roomCard) return;

      const roomHeader = roomCard.querySelector('.room-header h5');
      const roomName = roomHeader ? roomHeader.textContent.trim() : '';

      const floorBadge = roomCard.querySelector('.badge');
      const floorText = floorBadge ? floorBadge.textContent.trim() : '';

      // Extract floor number - either from floor text or from the active floor
      let floorNum = '';
      if (floorText) {
        const match = floorText.match(/Floor\s+(\d+)/);
        if (match) floorNum = match[1];
      }

      // If no floor number found, try to get it from the active floor container
      if (!floorNum) {
        const floorContainer = roomCard.closest('.floor-container');
        if (floorContainer) {
          const floorIdMatch = floorContainer.id.match(/floor-(\d+)/);
          if (floorIdMatch) floorNum = floorIdMatch[1];
        }
      }

      // Set data attributes for filtering if not already set
      if (roomName && !card.dataset.room) {
        card.dataset.room = roomName.toLowerCase().replace(/\s+/g, '_');
      }
      if (floorNum && !card.dataset.floor) {
        card.dataset.floor = floorNum;
      }

      // Ensure device type is set
      if (!card.dataset.deviceType) {
        if (card.querySelector('.fa-thermometer-half')) {
          card.dataset.deviceType = 'temperature';
        } else if (card.querySelector('.fa-tint')) {
          card.dataset.deviceType = 'humidity';
        } else if (card.querySelector('.fa-lightbulb')) {
          card.dataset.deviceType = 'light';
        } else if (card.querySelector('.fa-wind')) {
          card.dataset.deviceType = 'ac';
        } else {
          // Get type from badge if exists
          const typeBadge = card.querySelector(
            '.card-header .badge:last-child'
          );
          if (typeBadge) {
            card.dataset.deviceType = typeBadge.textContent
              .trim()
              .toLowerCase();
          } else {
            card.dataset.deviceType = 'generic';
          }
        }
      }
    });

    console.log(
      `Enhanced ${deviceCards.length} device cards with data attributes for filtering`
    );

    // Add click handler for apply filter button
    const applyFilterBtn = document.getElementById('applyFilterBtn');
    if (applyFilterBtn) {
      applyFilterBtn.addEventListener('click', function () {
        applyDashboardFilters();
      });
    }

    // Show the filter container when we have devices
    if (deviceCards.length > 0) {
      const showFilterBtn = document.getElementById('showFilterBtn');
      if (showFilterBtn) {
        showFilterBtn.style.display = 'block';
      }
    }
  });

  // Improved filter function
  function applyDashboardFilters() {
    const floorFilter =
      document.getElementById('dashFilterFloor')?.value || 'all';
    const roomFilter =
      document.getElementById('dashFilterRoom')?.value || 'all';
    const typeFilter =
      document.getElementById('dashFilterType')?.value || 'all';

    console.log(
      `Applying filters: Floor=${floorFilter}, Room=${roomFilter}, Type=${typeFilter}`
    );

    const deviceCards = document.querySelectorAll('.device-card');
    let visibleCount = 0;
    let hiddenCount = 0;

    deviceCards.forEach((card) => {
      const cardFloor = card.dataset.floor || '';
      const cardRoom = card.dataset.room || '';
      const cardType = card.dataset.deviceType || '';

      console.log(
        `Card: floor=${cardFloor}, room=${cardRoom}, type=${cardType}`
      );

      const floorMatch = floorFilter === 'all' || cardFloor === floorFilter;
      const roomMatch = roomFilter === 'all' || cardRoom === roomFilter;
      const typeMatch = typeFilter === 'all' || cardType === typeFilter;

      const shouldShow = floorMatch && roomMatch && typeMatch;
      const container = card.closest('.device-card-container') || card;

      if (shouldShow) {
        container.style.display = '';
        container.classList.remove('filtered-out');
        visibleCount++;
      } else {
        container.style.display = 'none';
        container.classList.add('filtered-out');
        hiddenCount++;
      }
    });

    // Update filter summary
    updateDashFilterSummary(
      floorFilter,
      roomFilter,
      typeFilter,
      visibleCount,
      hiddenCount
    );

    // If all devices in a room are hidden, hide the room
    document.querySelectorAll('.room-card').forEach((roomCard) => {
      const visibleDevices = roomCard.querySelectorAll(
        '.device-card-container:not(.filtered-out)'
      ).length;
      if (visibleDevices === 0) {
        roomCard.style.display = 'none';
      } else {
        roomCard.style.display = '';
      }
    });

    return visibleCount;
  }

  function updateDashFilterSummary(
    floor,
    room,
    type,
    visibleCount,
    hiddenCount
  ) {
    const summary = document.getElementById('dash-filter-summary');
    if (summary) {
      summary.style.display = 'block';

      const floorText =
        floor === 'all'
          ? 'All Floors'
          : document.querySelector(`#dashFilterFloor option[value="${floor}"]`)
              ?.textContent || `Floor ${floor}`;

      const roomText =
        room === 'all'
          ? 'All Rooms'
          : document.querySelector(`#dashFilterRoom option[value="${room}"]`)
              ?.textContent || room;

      const typeText =
        type === 'all'
          ? 'All Types'
          : document.querySelector(`#dashFilterType option[value="${type}"]`)
              ?.textContent || type;

      summary.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>Showing:</strong> ${visibleCount} device${
        visibleCount !== 1 ? 's' : ''
      } 
            <span class="badge bg-primary">${floorText}</span>
            <span class="badge bg-secondary">${roomText}</span>
            <span class="badge bg-info">${typeText}</span>
          </div>
          <div>
            <small class="text-muted">${hiddenCount} device${
        hiddenCount !== 1 ? 's' : ''
      } hidden</small>
          </div>
        </div>
      `;
    }
  }

  // Make resetDashFilters globally available
  window.resetDashFilters = function () {
    const dashFilterFloor = document.getElementById('dashFilterFloor');
    const dashFilterRoom = document.getElementById('dashFilterRoom');
    const dashFilterType = document.getElementById('dashFilterType');

    if (dashFilterFloor) dashFilterFloor.value = 'all';
    if (dashFilterRoom) dashFilterRoom.value = 'all';
    if (dashFilterType) dashFilterType.value = 'all';

    applyDashboardFilters();

    // Reset room cards visibility
    document.querySelectorAll('.room-card').forEach((roomCard) => {
      roomCard.style.display = '';
    });

    // Hide the summary
    const summary = document.getElementById('dash-filter-summary');
    if (summary) {
      summary.style.display = 'none';
    }
  };
</script>
{% endblock %}
